---
author: "Fernando Moreno Jabato"
output: 
  html_document:
    df_print: paged
    fig_width: 12
---

<style>
    body .main-container {
        max-width: 95%;
    }
</style>


## **Phenotypes report**
This preport has been automatically generated by PhenFun protocol pipeline. Paper reference: **(https://github.com/fmjabato/PhenFun)**.

This documents contains information about results obtained after apply PhenFun protocol to obtain Phenotype-Functional Systems relations. This documents shows information obtain along different steps of PhenFun protocol for each phenotype term. Information shown are:

* **Title:** which contains the Phenotype ID, the Phenotype Name and the content index (IC) asigned during the workflow.
* **Parentals:** a table with parental Phenotypes into Human Phenotype Ontology (HPO).
* **OMIM diseases:** a table with phenotype OMIM related diseases.
* **FunSys enrichments:** table with final list of FunSys linked to the phenotype.
* **Patients affected:** table with source patients which have annotated the phenotype and any of the final FunSys related that can be infer to the patient.
* **Relations graphs:** three graps are shown given a quick view of all data previously shown:
  1. Connectivity graph of Patients with it phenotype and genes used to obtain any of final Phenotype-FunSys relations.
  2. Connectivity graph of FunSys terms finally related to it phenotype and genes used to obtain them.
  3. Heatmap of patients affected against FunSys terms finally related to it phenotype, coloured by the percentage of genes used to obtain the Phenotype-FunSys relation that are affected into patient profile.


```{r sort_type, echo=FALSE}
# Select sorting type:
#   TRUE  > Sorted by HPO ID (increasing)
#   FALSE > Sorted by HPO asigned IC (descending)
sort_type <- FALSE

if(sort_type){
  sort_text <- "Following phenotype terms have been sorted by their **ID** into the Human Phenotype Ontology in **increasing** order."
}else{
  sort_text <- "Following phenotype terms have been sorted by their assigned **Index of Content (IC)** in **decreasing** order."
}

```

`r paste(knit(text = paste(sort_text,collapse = "\n")),collapse = "\n")`

```{r confidential_mode, echo = FALSE}
# Check confidential mode
conf_mode <- data[['conf_pats_ids']]
if(is.null(conf_mode)){
  conf_mode <- FALSE
}else{
  allowed_pats <- conf_mode[,1]
  conf_mode <- TRUE
}
```




```{r setup, include=FALSE, eval = TRUE}
################################################### Load necessary packages
require(knitr)
require(ggplot2)
require(ontologyIndex)
require(org.Hs.eg.db)
require(igraph)
require(naniar)
require(metap)

################################################### Load necessary datasets

# Necessary datasets are:
#   1 > Enrichments file: file with final set of Phenotype-FunSys links with format [Header: True; Info: <HPO_ID>,<HPO_IC>,<SignalAmount>,<SignalList>]
#   2 > FunSys dict: file with information about FunSys terms with format [Header: True; Info: <FS_ID>,<FS_IC>,<FS_Name>]
#   3 > Diseases profiles: diseases related info with format [Header: False; Info: <Dis_ID>,<Dis_Name>,<Dis_Pheno>]
#   4 > Patient triplets: file with relations Phenotype-FunSys-Patient-Gene with format [Header: True; Info: <Phenotype>,<FunSys>,<Patient>,<EnrichGenes>,<PatGenes>,<SharedGenes>,<GenesCoverage>,<SharedGenesList>]



# Load Phenotype-FunSys source data
enrichments <- data[[1]]
colnames(enrichments) <- c("Phenotype","Phenotype_IC","FunSys_Terms_Amount","FunSys_Terms")

# Load FunSys dictionary 
fs_dict <- data[[2]]
colnames(fs_dict) <- c("FunSys","FunSys_IC","FunSys_Name")

# Load diseases profiles
diseases <- data[[3]]
colnames(diseases) <- c("Disease","Disease_Name","Phenotype")

# Load patient triplets
patients <- data[[4]]
colnames(patients) <- c("Phenotype","FunSys","Patient","FunSys_Genes","Patient_Genes","Shared_Genes","Genes_Coverage","Shared_Genes_List")
patients$Patient <- as.character(patients$Patient)
patients$FunSys_Name <- unlist(lapply(patients$FunSys,function(funs){
  indx <- which(fs_dict$FunSys == funs)
  ifelse(length(indx) == 0, funs, fs_dict$FunSys_Name[indx])
}))

# Obtain and sort phenotypes
if(sort_type){ # By ID (increasing)
  phenotypes <- sort(unique(enrichments$Phenotype))
}else{ # By IC (descending)
  phenotypes <- enrichments[order(enrichments$Phenotype_IC,decreasing=T),]
  phenotypes <- unique(phenotypes$Phenotype)
}

# Real model unfitlered enrichments
real_enrichments <- data[[5]]
colnames(real_enrichments) <- c("Phen","Onto","Fun","Pval","Genes")

# Prepare recursive text
chunks <- function(code, options = ""){paste(paste("```{r ",options,"}",sep = ""),code,"```",sep="\n")}
render <- function(text){paste(knit(text = paste(text,collapse = "\n")),collapse = "\n")}

# Prepare all HPO reports container
out <- NULL
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
```

```{r Update_Raw_Rels, include = FALSE}
# Find list of unique phenotypes/funsys into RAW
raw_phenos <- lapply(phenotypes,function(hp){which(real_enrichments$Phen == hp)})
raw_funsys <- lapply(unique(patients$FunSys),function(fs){which(real_enrichments$Fun == fs)})

names(raw_phenos) <- phenotypes
names(raw_funsys) <- unique(patients$FunSys)

# Update patients table
patients$Pval <- rep(NaN,nrow(patients))
enrich_dict <- as.data.frame(do.call(rbind,lapply(phenotypes,function(hp){
  # Find into patients
  indx_pats <- which(patients$Phenotype == hp)
  indx_raw_phen <- raw_phenos[[hp]]
  # Obtain related funsys
  funsys <- unique(patients$FunSys[indx_pats])
  # Update HPO-FunSys pval relation value
  info <- as.data.frame(do.call(rbind,lapply(funsys,function(fs){
    # Find
    indx_target <- intersect(indx_pats,which(patients$FunSys == fs))
    indx_raw <- intersect(indx_raw_phen,raw_funsys[[fs]])
    # Update
    if(length(indx_raw > 0)){
      pv <- real_enrichments$Pval[indx_raw[1]]
    }else{
      pv <- NaN
    }
    if(length(indx_target) > 0 & length(indx_raw) > 0){
      patients$Pval[indx_target] <<- pv
    }
    # return
    return(data.frame(Pheno = hp, FunSys = fs, Pval = pv))
  })))
  return(info)
})))

```

```{r Pheno_Info, include = FALSE}
data(hpo)
HPOs <- data.frame(Term = phenotypes,
                   Phenotype_IC = unlist(lapply(phenotypes,function(hp){enrichments$Phenotype_IC[which(enrichments$Phenotype == hp)[1]]})),
                   Name = unlist(lapply(phenotypes,function(hp){ifelse(hp %in% hpo$id, get_term_property(hpo,"name",hp),hp)})), stringsAsFactors = F)

# Increase info
HPOs <- as.data.frame(do.call(rbind,lapply(seq(nrow(HPOs)),function(i){
  # Obtain HPO id
  hp <- HPOs$Term[i]
  # Find into patients results
  indx_hp <- which(patients$Phenotype == hp)
  indx_dict <- which(enrich_dict$Pheno == hp)
  # Obtain FunSys, Patients, Enriching genes and relations pvalues
  funsys <- enrich_dict$FunSys[indx_dict] 
  pats   <- length(unique(patients$Patient[indx_hp]))
  pvals  <- enrich_dict$Pval[indx_dict] 
  genes  <- length(unique(unlist(lapply(patients$Shared_Genes_List[indx_hp],function(lst){unlist(strsplit(lst,";"))}))))
  # Study funsys
  fs_ics <- fs_dict$FunSys_IC[which(fs_dict$FunSys %in% funsys)]
  funsys <- length(funsys)
  # Integrate pvals
  sumlog_pvals <- sum(-2*log(pvals))

  # Return info
  return(data.frame(Term      = hp,
                    Name      = HPOs$Name[i],
                    Integrated_FS_Score = sumlog_pvals/funsys,
                    Phenotype_IC = HPOs$Phenotype_IC[i],
                    Max_FS_IC = max(fs_ics),
                    Mean_FS_IC = mean(fs_ics),
                    Min_FS_Pval  = min(pvals),
                    FunSys    = funsys,
                    Patients  = pats,
                    Genes_Enr = genes,
                    stringsAsFactors = FALSE))
})))

# Sort
HPOs <- HPOs[order(-HPOs$Integrated_FS_Score,-HPOs$Phenotype_IC),]
```


## **Summary results**
A summary table with results metadata is included bellow. Data included into this table are:

* **Name:** phenotype term name.
* **Integrated_FS_Score:** integration of all FunSys-Phenotype relationships p-values. $\frac{\sum{i=1}{N} -2log(p_{i}))}{N}$
* **Phenotype_IC:** phenotype assigned IC.
* **Max_FS_IC:** maximum linked FunSys term IC. 
* **Mean_FS_IC:** mean linked FunSys term IC.
* **Min_FS_Pval:** minimum linked FunSys relationship p-value.
* **FunSys:** number of FunSys linked.
* **Patients:** number of Patients with linkable results by FunSys results.
* **Genes_Enr:** genes being used into a FunSys-Phenotype relationship.

Table has been ordered in decreasing order based on "Integrated_FS_Score" value.
**WARNING:** some term names can appear using their ID. It means that dictionary package version (ontologyIndex) is using an ontology version which not includes it term.

```{r print_metaresults,echo = FALSE}
HPOs[which(HPOs$Patients > 0),-which(colnames(HPOs) %in% c("Term"))]
```










```{r Report_Info, include = FALSE, eval = TRUE}
# Prepare genes info
genes_all <- mapIds(org.Hs.eg.db, names(as.list(org.Hs.egGO[mappedkeys(org.Hs.egGO)])),'SYMBOL','ENTREZID')
genes_all <- data.frame(ENTREZ = names(genes_all), SYMBOL = as.vector(genes_all), stringsAsFactors = F)

# Prepare info
report_data <- lapply(phenotypes, function(hp){
  # Generate header text
  indx <- which(HPOs$Term == hp)
  header <- paste(hp," (",HPOs$Phenotype_IC[indx],") ", HPOs$Name[indx], sep = "")

  # Calculate parentals
  parentals <- as.data.frame(do.call(rbind,lapply(tail(head(get_ancestors(hpo,hp),-1),-1),function(p){
    return(data.frame(Name = get_term_property(hpo,'name',p), stringsAsFactors = F))
  })))
  if(nrow(parentals)> 0){
    parentals$Term <- rownames(parentals)
    parentals <- parentals[,c(2,1)]
  }

  # Find OMIM related diseases
  dis <- diseases[which(diseases$Phenotype == hp),c("Disease","Disease_Name")]

  # Obtain related FunSys terms
  fs <- fs_dict[which(fs_dict$FunSys %in% unlist(strsplit(enrichments$FunSys_Terms[which(enrichments$Phenotype == hp)],";"))),]

  # Obtain info of results that can be inferred to patients
  pats <- patients[which(patients$Phenotype == hp),-1]

  # Prepare auxiliar dataframe to be plotted
  aux_pats <- as.data.frame(do.call(rbind,lapply(seq(nrow(pats)),function(i){
    # Obtain genes
    genes <- unlist(strsplit(pats$Shared_Genes_List[i],";"))
    # Translate genes
    genes <- genes_all$SYMBOL[which(genes_all$ENTREZ %in% genes)]
    # return
    return(data.frame(Patient     = as.character(rep(pats$Patient[i],length(genes))),
                      FunSys_Name = rep(pats$FunSys_Name[i],length(genes)), 
                      Gene        = genes))
  })))

 
  # Return info
  return(list(Header     = header,
              Parentals  = parentals,
              Diseases   = dis,
              Enrichment = fs,
              Patients   = pats,
              Plots_Info = aux_pats))
})
names(report_data) <- phenotypes
```












```{r test,echo = FALSE, eval = TRUE}
# phenotypes
# enrichments
# fs_dict
# diseases
# patients
# HPOs
# report_data
```



## **List of Phenotypes with results (`r length(phenotypes)`)**

```{r Report_Body, echo = FALSE, eval = TRUE}
invisible(lapply(phenotypes,function(hp){
# invisible(lapply(phenotypes[1:3],function(hp){

  # Prepare header
  header <- report_data[[hp]]$Header  

  # Obtain parental information
  text_parental <- "Known parental terms into HP Ontology are:"
  code_parental <- "report_data[['{{hp}}']]$Parentals"

  # Obtain related diseases
  text_disease <- "Known OMIM related diseases are:"
  code_disease <- "report_data[['{{hp}}']]$Diseases" 

  # Obtain enrichments table
  text_enrichment <- "After all steps, final list of FunSys related to this phenotype are:"
  code_enrichment <- "report_data[['{{hp}}']]$Enrichment"

  # Obtain patients whith inferred results
  if(conf_mode){
    text_patients <- "**NOTE:** confidential mode has been activated, it means that inferred results over patients have been removed (table and two plots)"
    code_patients <- "message('CONFIDENTIAL MODE: INFERRED RESULTS TABLE HAS BEEN REMOVED')"
  }else{
    text_patients <- "Results which can be inferred to patient are:"
    code_patients <- "report_data[['{{hp}}']]$Patients"
  }

  # Obtain plots generated
  text_plots <- "Relations plots:\n"
  code_plots <- "aux_pats <- report_data[['{{hp}}']]$Plots_Info
    if(conf_mode){
      pp2 <- ggplot(aux_pats, aes(x = FunSys_Name, y = Gene)) +
             geom_tile(colour='white',size=0.25) +
             aes(stringr::str_wrap(FunSys_Name, 20),Gene) +
             labs(y = 'Affected gene', x = 'FunSys term') +
             theme(axis.text.x = element_text(angle = 90)) 
      plot(pp2)
    }else{
      pp1 <- ggplot(aux_pats, aes(x = Patient, y = Gene)) +
           theme(axis.text.x = element_text(angle = 90)) +
           labs(y = 'Affected gene') +
           geom_tile(colour='white',size=0.25)
      pp2 <- ggplot(aux_pats, aes(x = FunSys_Name, y = Gene)) +
             geom_tile(colour='white',size=0.25) +
             aes(stringr::str_wrap(FunSys_Name, 20),Gene) +
             labs(y = 'Affected gene', x = 'FunSys term') +
             theme(axis.text.x = element_text(angle = 90)) 
      pp3 <- ggplot(report_data[['{{hp}}']]$Patients,aes(x = Patient, y = FunSys_Name, fill = Genes_Coverage)) +
            # Plot
            geom_tile(colour='white',size=0.25) +
            scale_fill_gradient2(limits=c(0,1),low='blue', mid='white', high='red',na.value='grey') +
            theme(axis.text.x = element_text(angle = 90)) +
            aes(Patient,stringr::str_wrap(FunSys_Name, 25)) +
            labs(fill='% Genes Coverage', y = 'FunSys term')

      grid.arrange(pp1,pp2, nrow = 1)
      plot(pp3)
    }
    "
  

  # Prepare output code
  hp_id <- gsub(":","",hp)
  out <<- c(out,paste("<details><summary><font size='+1.5'><strong>",
                       header,
                       "</strong></font></summary>",
                       knit_expand(text = paste(text_parental,
                                       chunks(code_parental, options = "rownames.print = FALSE"),
                                       text_disease,
                                       chunks(code_disease, options = "rownames.print = FALSE"),
                                       text_enrichment,
                                       chunks(code_enrichment, options = "rownames.print = FALSE"),
                                       text_patients,
                                       chunks(code_patients, options = "rownames.print = FALSE"),
                                       text_plots,
                                       chunks(code_plots),
                                       "\n",sep = "\n")),
                       "</details>", sep = "\n"))

}))

```



  `r paste(knit(text = paste(out,collapse = "\n")),collapse = "\n")`



