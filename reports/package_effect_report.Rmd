---
author: "Fernando Moreno Jabato"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    fig_width: 12
---

<style>
    body .main-container {
        max-width: 90%;
    }
</style>


```{r config, include = FALSE}
###########################################
##               PACKAGES                ##
###########################################

# Load necessary packages
suppressPackageStartupMessages(require(knitr))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(igraph))
suppressPackageStartupMessages(require(grid))
suppressPackageStartupMessages(require(naniar))
suppressPackageStartupMessages(require(dplyr))

###########################################
##               CONFIGURE               ##
###########################################

# Select special models
model_target_old <- "dec"
model_target <- "Real"
model_gold <- "hpo"

# Prepare pvalues used
pval_thr   <- c(1e-3,1e-4,1e-5)
hyi_thr    <- 2.0
model_cols <- c("dodgerblue3","firebrick2","olivedrab4","aquamarine3","darkorchid3")



# Prepare recursive text
chunks <- function(code){paste("```{r}",code,"```",sep="\n")}

###########################################
##                MODULEs                ##
###########################################
flags <- list(pack_plots   = TRUE,
	          process_data = TRUE)

```


```{r load_data, include = FALSE}
##################################################
##                    LOAD                      ##
##################################################

# Load META-GO enrichments
meta_go <- data[['meta_go']]
	meta_go$Model      <- as.character(meta_go$Model)
	meta_go$HPO        <- as.character(meta_go$HPO)
	meta_go$Pval       <- as.double   (meta_go$Pval)
	meta_go$BP         <- as.numeric  (meta_go$BP)
	meta_go$CC         <- as.numeric  (meta_go$CC)
	meta_go$MF         <- as.numeric  (meta_go$MF)
	meta_go$Genes      <- as.numeric  (meta_go$Genes)
	meta_go$GenesList  <- as.double   (meta_go$GenesList)
	meta_go$SignalList <- as.character(meta_go$SignalList)
	meta_go$GenesPercentageOfTotal <- as.character(meta_go$GenesPercentageOfTotal)

	# Add new columns
	meta_go$Terms <- meta_go$BP + meta_go$CC + meta_go$MF
				

# Load RDM models info
rdm_models <- data[['rdm_models_info']]
	rdm_models$Model       <- as.character(rdm_models$Model)
	rdm_models$Format      <- as.character(rdm_models$Format)
	rdm_models$Locis       <- as.logical(rdm_models$Locis)
	rdm_models$Description <- as.character(rdm_models$Description)
	rdm_models$Name        <- as.character(rdm_models$Name)
	rdm_models$ID          <- as.character(rdm_models$ID)


# Load data
meta_pack <- data[['pack_go']]



```


```{r process_data, include = FALSE, eval = flags$process_data}
##################################################
##                   TRANSFORM                  ##
##################################################




```







## **Genes Package Effect study**
Graphs to be plotted:

* **Graph 1:** barplot with number of Phenotype-FunSys links per model type.
* **Graph 2:** barplot with percentage of SORs which gives >1 gene for an HPO enrichment.
* **Graph 3:** boxplot with number of genes eriched into an HPO from a _package SOR_ .
* **Graph 4:** scatter plot with a dot per HPO and X = number of SORs linked, Y = number of SORs linked with _package effect_ .

```{r pack_gene, echo = FALSE, eval = flags$pack_plots}
##################################################
##                   PACK GENES                 ##
##################################################

# Definne plotter function
plot_pack_genes <- function(meta_info, models_formats, models_levels, meta_pack = NULL, fs_name, models_colors){
	### PREPARE DATA
	# Group data by model 
	PhenFun_per_model <- meta_info %>%
						 group_by(Model) %>%
						 summarise(Phenotypes = n(),
						 		   Links      = sum(Terms),
						 		   Mean_Links = mean(Terms))
	# Substitute model names by model Type
	PhenFun_per_model$Model_Type <- PhenFun_per_model$Model 
	invisible(lapply(seq_along(models_formats$Format),function(i){
		# Take format
		format <- models_formats$Format[i]
		# Find models
		indx <- which(grepl(format,PhenFun_per_model$Model_Type))
		# Update
		PhenFun_per_model$Model_Type[indx] <<- models_formats$ID[i]
	}))

	# Calculate Standard deviation per model
	PhenFun_per_model_g <- PhenFun_per_model %>%
						   group_by(Model_Type) %>%
						   summarise(Mean_Links = mean(Links),         # Mean
						   			 sd_Links   = sd(Links),           # Standard deviation
						   			 Num_Models = n(),                 # Num models
						   			 se_links   = sd(Links)/sqrt(n())) # Standard error
	# Set levels
	PhenFun_per_model_g$Model_Type <- factor(PhenFun_per_model_g$Model_Type, levels = models_levels)


	# Graph 1: barplot with number of Phen-Funsys links per model type
	graph1 <- ggplot(PhenFun_per_model_g, aes(x = Model_Type, y = Mean_Links, fill = Model_Type)) +
			  geom_col() +
			  scale_fill_manual(values = models_colors, name = "Model") +
			  theme(axis.text.x = element_blank()) +
			  geom_errorbar(aes(ymin = Mean_Links - sd_Links, ymax = Mean_Links + sd_Links), width = 0.2) +
			  labs(x = "", y = paste(fs_name,"Phen links Â± s.d.",sep="-"))

	plot(graph1)


	# Calculate Pack-genes effect (>1 genes enriching an HPO from a SOR)
	meta_pack_models <- as.data.frame(do.call(rbind,lapply(unique(meta_pack$Model),function(model){
		# Find
		indx <- which(meta_pack$Model == model)
		subset <- meta_pack[indx,]
		# Obtain info
		sors <- unique(subset$SOR)
		pack_indx <- which(subset$Package_Effect == TRUE)
		pack_sors <- length(which(unlist(lapply(sors,function(sor){length(intersect(pack_indx, which(subset$SOR == sor)))>0}))))
		# Return info
		return(data.frame(Model      = model,
						  Model_Type = "Real",
						  SORs       = length(sors),
						  Pack_SORs  = pack_sors,
						  Perc_Packs = pack_sors / length(sors),
						  Pack_Instances = length(pack_indx),
						  stringsAsFactors = F))
	})))



	# Add Model Type
	meta_pack$Model_Type <- rep("Real",nrow(meta_pack))
	invisible(lapply(seq_along(models_formats$Format),function(i){
		# Take format
		format <- models_formats$Format[i]
		# Find models
		indx <- which(grepl(format,meta_pack_models$Model))
		indx2 <- which(grepl(format,meta_pack$Model))
		# Update
		meta_pack_models$Model_Type[indx] <<- models_formats$ID[i]
		meta_pack$Model_Type[indx2] <<- models_formats$ID[i]
	}))

	# Add levels
	meta_pack_models$Model_Type <- factor(meta_pack_models$Model_Type, levels = models_levels)
	meta_pack$Model_Type <- factor(meta_pack$Model_Type, levels = models_levels)


	# Graph 2: % of SORs with Pack Effect per model 
	graph2 <- ggplot(meta_pack_models, aes(x = Model_Type, y = Perc_Packs, fill = Model_Type)) +
			  geom_boxplot(na.rm = TRUE) +
			  theme(axis.text.x = element_blank()) +
			  scale_fill_manual(values = models_colors, name = "Model") +
			  labs(x = "", y = paste("Proportion SORs have given >1 gene for a",fs_name,"enrichment"))
	plot(graph2)	  

	message("WARNING: graph 3, for randoms, plot raw data for all replicates of each random model type, is not showing means or other altered data!")

	# Graph 3: boxplot with number of genes eriched into an HPO from an specific package SOR
	graph3 <- ggplot(meta_pack[which(meta_pack$Package_Effect == TRUE),],aes(x = Model_Type, y = EnrichGenes, fill = Model_Type)) +
			  geom_boxplot(na.rm = TRUE) +
			  theme(axis.text.x = element_blank()) +
			  scale_fill_manual(values = models_colors, name = "Model") +
			  labs(x = "", y = "Genes given by a Pack-SOR to enrich into a Phenotype")
	plot(graph3)


	# Calculate HPO-SORs and HPO-PackSORs per each model type
	phen_sor_metainfo <- as.data.frame(do.call(rbind,lapply(unique(meta_pack$Model_Type),function(model){
		sub_data <- meta_pack[which(meta_pack$Model_Type == model),]
		num_models <- length(unique(sub_data$Model))
		pack_sors_indx <- which(sub_data$Package_Effect == TRUE)
		# Obtain list of phenotpypes
		phenos <- unique(sub_data$Pheno)
		# Obtain info per pheno
		info <- as.data.frame(do.call(rbind,lapply(phenos,function(pheno){
			# Find
			indx <- which(sub_data$Pheno == pheno)
			# Obtain info
			sor <- length(indx) / num_models
			pack_sors <- length(intersect(indx,pack_sors_indx)) / num_models

			# Obtain Genes and PackEffect Genes
			genes_info <- as.data.frame(do.call(rbind,lapply(unique(sub_data$Model[indx]),function(model){
				# Find
				model_indx <- intersect(which(sub_data$Model == model), indx)
				# Obtain info
				genes <- sub_data$Pheno_E_Genes[model_indx[1]]
				pe_genes <- unique(unlist(lapply(intersect(model_indx,pack_sors_indx),function(i){
					unlist(strsplit(sub_data$GenesList[i],":"))
				})))
				# Return info
				return(data.frame(Genes = genes,
								  PE_Genes = length(pe_genes),
								  stringsAsFactors = FALSE))
			})))

			# Return info
			return(data.frame(Model      = model,
							  Replicates = num_models,
							  Pheno      = pheno,
							  SORs       = sor,
							  PE_SOR     = pack_sors,
							  Genes      = sum(genes_info$Genes) / num_models,
							  PE_Genes   = sum(genes_info$PE_Genes) / num_models,
							  stringsAsFactors = FALSE))
		})))
	})))

	# Graph 4: Per each phenotype, plot the number of SORs and the nomber of them that show Package Effect
	sc_plots <- lapply(unique(phen_sor_metainfo$Model),function(model){
		ggplot(phen_sor_metainfo[which(phen_sor_metainfo$Model == model),], aes(x = SORs, y = PE_SOR)) +
		geom_point(alpha = 0.2, na.rm = TRUE) +
      	labs(x = "Phenotype linked SORs", y = "Package Effect SORs", title = model)
	})

	# Plot
	do.call("grid.arrange", c(sc_plots, ncol=2))



	# Graph 5: per each phenotype, plot the number of genes used to enrich FunSys relationships and the number of them that comes from a PackEffect SOR
	sc2_plots <- lapply(unique(phen_sor_metainfo$Model),function(model){
		ggplot(phen_sor_metainfo[which(phen_sor_metainfo$Model == model),], aes(x = Genes, y = PE_Genes)) +
		geom_point(alpha = 0.2, na.rm = TRUE) +
      	labs(x = "Phenotype enrich genes", y = "Genes from PE_SORs", title = model)
	})

	# Plot
	do.call("grid.arrange", c(sc2_plots, ncol=2))
}



head(meta_pack)

# Plot 
plot_pack_genes(meta_info      = meta_go[which(meta_go$Pval == 1e-3),],
				models_formats = rdm_models, 
				models_levels  = c(model_target,rdm_models$ID), 
				meta_pack      = meta_pack,
				fs_name        = "GO", 
				models_colors  = head(model_cols,-1))


# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
```
