---
author: "Fernando Moreno Jabato"
output: 
  html_document:
    df_print: paged
    fig_width: 12
---

<style>
    body .main-container {
        max-width: 95%;
    }
</style>


```{r config, include = FALSE}
# Load necessary packages
require(knitr)
require(ggplot2)
require(ontologyIndex)
require(org.Hs.eg.db)

# Instance useful variables
thr_cov <- 0.55
out <- NULL

# Prepare usefull functions
chunks <- function(code, options = ""){paste(paste("```{r ",options,"}",sep = ""),code,"```",sep="\n")}
```

```{r confidential_mode, echo = FALSE}
# Check confidential mode
conf_mode <- data[['conf_pats_ids']]
if(is.null(conf_mode)){
	conf_mode <- FALSE
}else{
	allowed_pats <- conf_mode[,1]
	conf_mode <- TRUE
}
```





## **Patients report**
This preport has been automatically generated by PhenFun protocol pipeline. Paper reference: **(https://github.com/fmjabato/PhenFun)**.

This documents contains information about results inferred over initial patients cohort. This results are obtained after apply PhenFun protocol to obtain Phenotype-Functional Systems relations. This documents shows information obtain along different steps of PhenFun protocol for each phenotype term. Information shown are:

* **Phenotype:** phenotypes annotated for a patient.
* **Phenotype with results (Sig_Phenotype):** phenotypes which have any Phenotype-FunSys relationship in the final results set.
* **Explanable Phenotypes (Exp_Phenotypes):** phenotypes with results that can be inferred to the patient by it phenome and affected genes.
* **Genes:** genes affected by patient mutations.
* **Genes which enrich any FunSys (Sig_Genes):** genes which have been used to enrich any Phenotype-FunSys relation in any of the phenotypes affected in the patient.


This information will be structured by patient with the following order: 

* **Title:** which contains the Patient ID, the Patient Phenome Coverage and the mean phenome content index (IC) asigned during the workflow.
* **Profile summary:** a barplot with a summary of the phenotypes, genes and FunSys affected and with results.
* **Phenome:** a table with annotated phenotypes ID and name and a column which indicates if has, or not, results assigned into the final filtered set.
* **Relations plot:** a set of plots which shows the relationship between inferred Phenotype-FunSys, FunSys-Gene and Gene-Phenotype. In case of Phenotype-FunSys a color gradient is used to show the percentage of used enrichment genes that are present into the patient. 

A **threshold** over coverage feature have been applied during this report renderization. Coverage threshold applied have been **`r thr_cov`** and patient shown have been sorted by decreasing coverage value.










```{r load_data, include = FALSE}
################################################### Load necessary datasets

# Necessary datasets are:
#   1 > Triplets file: file with final set of Phenotype-FunSys-Patient links with format [Header: True; Info: <Pheno>,<FunSys>,<Patinet>,<EnrichGenes>,<PatientSigGenes>,<SharedGenes>,<GenesCoverage>,<SharedGenesList>]
#   2 > Patietns metadata: file with patients metadata information obtained from results with format [Header: True; Info: <Patient>,<NumPhenos>,<NumSORs>,<SORsWithGenes>,<Genes>,<Sig_Phenos>,<Sig_Genes>,<PercSigGenes>,<LinkablePhenos>,<Systems>,<SystemsUnique>,<PhenosPerSys>,<ProfMeanIC>,<HPOsWithoutIC>,<PhenosList>,<PhenosSigList>,<GenesList>,<GenesSigList>,<SystemList>]
#   3 > FunSys dict: file with information about FunSys terms with format [Header: True; Info: <FS_ID>,<FS_IC>,<FS_Name>]
#	4 > Phenotype frequencies: file with frequencies per HPO ID with format [Header: False; Info: <Pheno_ID>,<Freq>]

# Load triplets
triplets <- data[[1]]
colnames(triplets) <- c("Phenotype","FunSys","Patient","FunSys_Enrichment_Genes","Patient_Sig_Genes","Shared_Genes","Enrichment_Coverage","Shared_Genes_List")

# Load metadata
meta_pats <- data[[2]]
colnames(meta_pats) <- c("Patient","Phenotypes","SORs","SORs_With_Genes","Affected_Genes","Phenotypes_With_FunSys","Significant_Genes","Perc_Sig_Genes","Explanable_Phenotypes",
						"Inferred_FunSys","Inferred_FunSys_Unique","Phenotypes_Per_FunSys","Mean_Phenome_IC","Phenotypes_Without_IC","Phenotypes_List","Sig_Phenotypes_List","Affected_Genes_List","Sig_Genes_List","FunSys_List")
meta_pats$Coverage <- meta_pats$Explanable_Phenotypes / meta_pats$Phenotypes  # Add coverage
meta_pats <- meta_pats[which(meta_pats$Coverage >= thr_cov),]                 # Filter by threshold

# Load FunSys dictionary
fs_dict <- data[[3]]
colnames(fs_dict) <- c("Term","IC","Name")

# Verbose
out_conf <- ""

# Check confidential mode
if(conf_mode){
	triplets <- triplets[which(triplets$Patient %in% allowed_pats),]
	meta_pats <- meta_pats[which(meta_pats$Patient %in% allowed_pats),]

	# Randomizate patient IDs
	pick.nums <- function(n){floor(10^(sample(6:8,n,replace = TRUE))*runif(n))}
	rdm_allowed <- pick.nums(length(allowed_pats))
	# Substitute
	invisible(lapply(seq_along(allowed_pats),function(i){
		indx_trip <- which(triplets$Patient == allowed_pats[i])
		indx_meta <- which(meta_pats$Patient == allowed_pats[i])
		if(length(indx_trip) > 0){
			triplets$Patient[indx_trip] <<- rdm_allowed[i]
		}
		if(length(indx_meta) > 0){
			meta_pats$Patient[indx_meta] <<- rdm_allowed[i]
		}
	}))

	# Verbose
	out_conf <- "**NOTE: confidential mode has been activated**. Only allowed patient's IDs will be shown and their IDs has been randomized"
}

```
`r paste(knit(text = paste(out_conf,collapse = "\n")),collapse = "\n")`

```{r Pheno_Info, include = FALSE}
phenotypes <- unique(unlist(lapply(seq(nrow(meta_pats)),function(i){unlist(strsplit(meta_pats$Phenotypes_List[i],";"))})))

data(hpo)
HPOs <- data.frame(Term = phenotypes,
                   Name = unlist(lapply(phenotypes,function(hp){
                   						if(hp %in% hpo$id){
                   							get_term_property(hpo,"name",hp)
                   						}else{
                   							return(hp)
                   						}})), stringsAsFactors = F)

# Translate phenotypes
invisible(lapply(phenotypes,function(hp){
	# Find
	indx <- which(triplets$Phenotype == hp)
	# Update
	triplets$Phenotype[indx] <<- HPOs$Name[which(HPOs$Term == hp)]
}))


# Translate GO terms
invisible(lapply(unique(triplets$FunSys),function(fs){
	# Find
	indx <- which(triplets$FunSys == fs)
	# Obtain name
	fs_name <- which(fs_dict$Term == fs)
	if(length(fs_name) == 0){
		fs_name <- fs
	}else{
		fs_name <- fs_dict$Name[fs_name]
	}
	# Update
	triplets$FunSys[indx] <<- fs_name
}))


```








```{r Report_data, include = FALSE}
# Obtain list of patients
patients <- meta_pats[,c("Patient","Coverage","Mean_Phenome_IC")]
patients <- patients[order(patients$Coverage, patients$Mean_Phenome_IC, decreasing = T),]

# Entrez to Gene Name
genes_all <- mapIds(org.Hs.eg.db, names(as.list(org.Hs.egGO[mappedkeys(org.Hs.egGO)])),'SYMBOL','ENTREZID')
genes_all <- data.frame(ENTREZ = names(genes_all), SYMBOL = as.vector(genes_all), stringsAsFactors = F)

# Per each patient, obtain necessary data
if(nrow(patients) > 0){

	pat_data <- lapply(seq(nrow(patients)),function(i){
		# Find patient meta info
		j <- which(meta_pats$Patient == patients$Patient[i])
		k <- which(triplets$Patient == patients$Patient[i])

		# Prepare header
		header <- paste(patients$Patient[i]," [Coverage: ",patients$Coverage[i],"; Phenome IC: ",patients$Mean_Phenome_IC[i], "]", sep = "")

		# Prepare quick view plot
		quick <- data.frame(Info  = c("Phenotypes","Phenotypes","Phenotypes","Genes","Genes","FunSys"),
							Value = c(meta_pats$Phenotypes[j],
									  meta_pats$Phenotypes_With_FunSys[j],
									  meta_pats$Explanable_Phenotypes[j],
									  meta_pats$Affected_Genes[j],
									  meta_pats$Significant_Genes[j],
									  meta_pats$Inferred_FunSys_Unique[j]),
							Type  = c("Original","With results","Explanable for patient","Original","Explanable for patient","Explanable for patient"),
							stringsAsFactor = F)


		# Add Phenome table
		phenome <- HPOs[which(HPOs$Term %in% unlist(strsplit(meta_pats$Phenotypes_List[j],";"))),]
		phenome$With_Results <- phenome$Term %in% unlist(strsplit(meta_pats$Sig_Phenotypes_List[j],";"))


		# Prepare triplets as Phenotype - GO - Gene triplet
		tri <- as.data.frame(do.call(rbind,lapply(k,function(indx){
			# Obtain triplet genes
			genes <- unlist(strsplit(triplets$Shared_Genes_List[indx],";"))
			# Translate to gene name
			genes <- genes_all$SYMBOL[which(genes_all$ENTREZ %in% genes)]
			# Translate phenotype
			# phen_name <- phenome$Name[which(phenome$Term == triplets$Phenotype[indx])]
			phen_name <- triplets$Phenotype[indx]
			# Translate FunSys
			fs_name <- triplets$FunSys[indx]
			# fs_name <- which(fs_dict$Term == triplets$FunSys[indx])
			# if(length(fs_name) == 0){
			# 	fs_name <- triplets$FunSys[indx]
			# }else{
			# 	fs_name <- fs_dict$Name[fs_name]
			# }
			# Return new triplets
			return(data.frame(Phenotype = rep(phen_name,length(genes)),
							  FunSys    = rep(fs_name,length(genes)),
							  Gene      = genes,
							  stringsAsFactor = F))
		})))


		# Return generated info
		return(list(Header   = header,
					Tri_Indx = k,
					Summary  = quick,
					Phenome  = phenome,
					Triplets = tri))
	})
	names(pat_data) <- patients$Patient
}
```




```{r test, echo = FALSE}
# triplets
# meta_pats
# fs_dict
# patients
# pat_data
```





## **List of Patients with inferred results (`r nrow(patients)`)**

```{r Report_body, include = FALSE}
if(nrow(patients) > 0){

	invisible(lapply(seq(nrow(patients)),function(i){
	# invisible(lapply(seq(nrow(patients)[1:5]),function(i){
		pat <- as.character(patients$Patient[i])
		# Prepare title info
		header <- pat_data[[pat]]$Header


		# Plot quick summary
		text_summary <- "A patient quick view of it affected phenotypes (annotated, with results and with a FunSys that can be linked to it patient) and genotype (genes affected and which are being used to infer a FunSys):"
		code_summary <- gsub("\\{\\{pat\\}\\}",as.character(pat),"aux <- pat_data[['{{pat}}']]$Summary
			aux$Info <- factor(aux$Info,levels = c('Phenotypes','Genes','FunSys'))
			aux$Type <- factor(aux$Type,levels = c('Original','With results','Explanable for patient'))
			pp <- ggplot(aux, aes(x = Info, y = Value, fill = Type)) +
				  geom_bar(stat = 'identity',position = position_dodge()) +
				  labs(y = 'Count') +
	        	  geom_text(aes(label = Value),vjust=-0.5, color='black', position = position_dodge(0.9), size=3.5)
	        plot(pp)")


	    # Add phenome info
	    text_phenome <- "\nPatient annotated phenome is:"
	    code_phenome <- gsub("\\{\\{pat\\}\\}",as.character(pat),"pat_data[['{{pat}}']]$Phenome")

	    # Add triplets plots
	    text_triplets <- "All inferred relations are now plotted:\n"
	    code_triplets <- gsub("\\{\\{pat\\}\\}",as.character(pat),"
	    	# Plot 1: FunSys-Gene
	    	pp1 <- ggplot(pat_data[['{{pat}}']]$Triplets, aes(x = Gene, y = FunSys)) +
	               geom_tile(colour='white',size=0.25) +
	               aes(Gene,stringr::str_wrap(FunSys, 35)) +
	               labs(x = 'Affected genes',y = 'FunSys affected on patient related by phenotypes') +  
	               theme(axis.text.x = element_text(angle = 45, hjust = 1))

	        pp2 <- ggplot(pat_data[['{{pat}}']]$Triplets, aes(x = Gene, y = Phenotype)) +
	               geom_tile(colour='white',size=0.25) +
	               aes(Gene,stringr::str_wrap(Phenotype, 25)) +
	               labs(x = 'Affected genes',y = 'Phenotypes') +  
	               theme(axis.text.x = element_text(angle = 45, hjust = 1))

	        pp3 <- ggplot(triplets[pat_data[['{{pat}}']]$Tri_Indx,],aes(x = Phenotype, y = FunSys, fill = Enrichment_Coverage)) +
	          # Plot
	          geom_tile(colour='white',size=0.25) +
	          scale_fill_gradient2(limits=c(0,1),low='blue', mid='white', high='red',na.value='grey') +
	          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	          aes(stringr::str_wrap(Phenotype,25),stringr::str_wrap(FunSys, 35)) +
	          labs(fill='% Enrichment Genes Coverage', y = 'FunSys affected on patient related by phenotypes',x = 'Phenotypes')



	        # Plot
	        grid.arrange(pp1,pp2, nrow = 1) 
	        plot(pp3)
	    ")


	 	out <<- c(out,paste("<details><summary><font size='+1.5'><strong>",
							header,
							"</strong></font></summary>",
							knit_expand(text = paste(text_summary,
													chunks(code_summary),
													text_phenome,
													chunks(code_phenome, options = "rownames.print = FALSE"),
													text_triplets,
													chunks(code_triplets),

													"\n",sep = "\n")),
							"</details>",sep = "\n"))
	}))
}else{
	out <- "**NOTE:** there is no patients with results for this kind of enrichment"
}


```



`r paste(knit(text = paste(out,collapse = "\n")),collapse = "\n")`

